<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Texture Ripper</title>
    <link rel="shortcut icon" type="image/png" href="icon.png"/>
    <script src="libs/fabric.min.js"></script>
    <style type="text/css" media="screen">
      @import "./vulf-sans/stylesheet.css";

      body {
        background-color: #292929;
        color: #eeeeec;
        text-align: center;
        font-family: 'Vulf Sans Embedded';
      }

      #ripper {
        border: 1px solid #eeeeec;
      }

      .controls {
        display: inline-block;
      }

      #work {
        align-items: center;
        display: inline-block;
      }

    </style>
  </head>
  <body>
    <h2>Texture Ripper</h2>
    <p>Get perspective accurate textures for 3D modeling and graphics from any image in an easy to use website.</p>
    
    <input type='file' id='button' multiple accept="image/png">
    <br>
    <div id="work">
      <canvas id="ripper" width="400" height="400"></canvas>
      <img id="preview">
    </div>

    <p id="resolution"></p>

    <script type="module">
      import init, {run, get_dimensions} from './wasm/wasm.js';

      const canvas = new fabric.Canvas('ripper', { selection: false });

      fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';

      function makeCircle(left, top, line1, line2) {
        var c = new fabric.Circle({
          left: left,
          top: top,
          strokeWidth: 2,
          radius: 6,
          fill: '#292929',
          stroke: '#eeeeec'
        });
        c.hasControls = c.hasBorders = false;

        c.line1 = line1;
        c.line2 = line2;

        return c;
      }

      function makeLine(coords) {
        return new fabric.Line(coords, {
          stroke: '#eeeeec',
          strokeWidth: 2,
          selectable: false,
          evented: false,
        });
      }

      var topHeight = (canvas.height / 4) * 3;
      var bottomHeight = canvas.height / 4;
      var rightWidth = (canvas.width / 4) * 3;
      var leftWidth = canvas.width / 4;

      const topLine = makeLine([bottomHeight, leftWidth, topHeight, leftWidth]);
      const leftLine = makeLine([bottomHeight, rightWidth, bottomHeight, leftWidth]);
      const rightLine = makeLine([topHeight, leftWidth, topHeight, rightWidth]);
      const bottomLine = makeLine([topHeight, rightWidth, bottomHeight, rightWidth]);

      canvas.add(topLine);
      canvas.add(leftLine);
      canvas.add(rightLine);
      canvas.add(bottomLine);

      const topLeftCircle = makeCircle(topLine.get('x1'), topLine.get('y1'), topLine, leftLine);
      const topRightCircle = makeCircle(topLine.get('x2'), topLine.get('y2'), rightLine, topLine);
      const bottomLeftCircle = makeCircle(bottomLine.get('x2'), bottomLine.get('y2'), leftLine, bottomLine);
      const bottomRightCircle = makeCircle(bottomLine.get('x1'), bottomLine.get('y1'), bottomLine, rightLine);

      canvas.add(topLeftCircle);
      canvas.add(topRightCircle);
      canvas.add(bottomLeftCircle);
      canvas.add(bottomRightCircle);

      canvas.on('object:moving', function(e) {
        var p = e.target;
        p.line1 && p.line1.set({
          x1: p.left,
          y1: p.top,
        });

        p.line2 && p.line2.set({
          x2: p.left,
          y2: p.top,
        });

        canvas.renderAll();
      });

      (async () => {
        await init();

        var button = document.getElementById('button');

        button.addEventListener('input', (event) => {
          let file = event.target.files[0];

          const reader = new FileReader();

          reader.readAsArrayBuffer(file);

          reader.onloadend = function() {
            const bytes = new Uint8Array(reader.result);

            const file = new File([bytes.buffer], "output.png", {type: 'image/png'});

            const image = new fabric.Image();
            image.setSrc(URL.createObjectURL(file));
            
            let resolution = get_dimensions(bytes);

            image.width = resolution.width;
            image.height = resolution.height;

            canvas.setDimensions({width: image.width, height: image.height});

            canvas.renderAll();

            canvas.setBackgroundImage(image, canvas.renderAll.bind(canvas), {
              left: image.width / 2,
              top: image.height / 2,
            });

            canvas.renderAll();
          };
        });
      })();
    </script>
  </body>
</html>
