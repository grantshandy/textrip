<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Texture Ripper</title>
    <link rel="shortcut icon" type="image/png" href="icon.png"/>
    <script src="libs/fabric.min.js"></script>
    <style type="text/css" media="screen">
      @import "./vulf-sans/stylesheet.css";

      body {
        background-color: #292929;
        color: #eeeeec;
        text-align: center;
        font-family: 'Vulf Sans Embedded';
      }

      #ripper {
        border: 1px solid #eeeeec;
      }

      .controls {
        display: inline-block;
      }

      #work {
        align-items: center;
        display: inline-block;
      }

    </style>
  </head>
  <body>
    <h2>Texture Ripper</h2>
    <p>Get perspective accurate textures for 3D modeling and graphics from any image in an easy to use website.</p>
    
    <input type='file' id='button' multiple accept="image/png">
    <br>
    <div id="work">
      <canvas id="ripper" width="400" height="400"></canvas>
      <img id="preview">
    </div>

    <p id="resolution"></p>

    <script type="module">
      import init, {run} from './wasm/wasm.js';

      var canvas = new fabric.Canvas('ripper', { selection: false });

      fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';

      function makeCircle(left, top, line1, line2) {
        var c = new fabric.Circle({
          left: left,
          top: top,
          strokeWidth: 2,
          radius: 12,
          fill: '#292929',
          stroke: '#eeeeec'
        });
        c.hasControls = c.hasBorders = false;

        c.line1 = line1;
        c.line2 = line2;

        return c;
      }

      function makeLine(coords) {
        return new fabric.Line(coords, {
          stroke: '#eeeeec',
          strokeWidth: 2,
          selectable: false,
          evented: false,
        });
      }

      var topLine = makeLine([100, 100, 300, 100]);
      var leftLine = makeLine([100, 300, 100, 100]);
      var rightLine = makeLine([300, 100, 300, 300]);
      var bottomLine = makeLine([300, 300, 100, 300]);

      canvas.add(topLine);
      canvas.add(leftLine);
      canvas.add(rightLine);
      canvas.add(bottomLine);

      var topLeftCircle = makeCircle(topLine.get('x1'), topLine.get('y1'), topLine, leftLine);
      var topRightCircle = makeCircle(topLine.get('x2'), topLine.get('y2'), rightLine, topLine);
      var bottomLeftCircle = makeCircle(leftLine.get('x1'), leftLine.get('y1'), leftLine, bottomLine);
      var bottomRightCircle = makeCircle(rightLine.get('x2'), rightLine.get('y2'), bottomLine, rightLine);

      canvas.add(topLeftCircle);
      canvas.add(topRightCircle);
      canvas.add(bottomLeftCircle);
      canvas.add(bottomRightCircle);

      canvas.on('object:moving', function(e) {
        var p = e.target;
        p.line1 && p.line1.set({
          x1: p.left,
          y1: p.top,
        });

        p.line2 && p.line2.set({
          x2: p.left,
          y2: p.top,
        });

        canvas.renderAll();
      });


      (async () => {
        await init();

        var button = document.getElementById('button');

        button.addEventListener('input', (event) => {
          let file = event.target.files[0];

          const reader = new FileReader();

          reader.readAsArrayBuffer(file);

          reader.onloadend = function() {
            const bytes = new Uint8Array(reader.result);

            const invertedImage = run(bytes);

            const file = new File([invertedImage.buffer], "output.png", {type: 'image/png'});

            const previewElem = document.getElementById('preview');
            previewElem.src = URL.createObjectURL(file);
          };
        });
      })();
    </script>
  </body>
</html>
